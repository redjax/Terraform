---
name: Manage GitHub Repository

on:
  workflow_dispatch:
    inputs:
      repo-name:
        description: 'Repository name'
        required: true
        type: string
      repo-description:
        description: 'Repository description'
        required: false
        default: 'This repository was provisioned with Terraform without a description.'
        type: string
      auto-init:
        description: 'Auto initialize repository with README and main branch'
        required: false
        default: true
        type: boolean
      additional-branches:
        description: 'Optional branches list (e.g., ''["dev","docs"]'')'
        required: false
        default: ''
        type: string
      github-owner:
        description: 'GitHub organization or user'
        required: false
        default: 'redjax'
        type: string
      visibility:
        description: 'Public or private visibility'
        required: false
        default: 'private'
        type: choice
        options:
          - private
          - public
      destroy:
        description: 'Perform destroy instead of deploy'
        required: false
        default: false
        type: boolean

jobs:
  plan:
    runs-on: ubuntu-latest
    environment: github_repo_plan

    steps:
      - uses: actions/checkout@v5

      - name: Set up OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: latest
          tofu_wrapper: false

      - name: Install latest Terragrunt
        run: |
          set -euo pipefail

          LATEST_VERSION=$(curl -s https://api.github.com/repos/gruntwork-io/terragrunt/releases/latest | jq -r .tag_name)
          
          echo "Installing Terragrunt ${LATEST_VERSION}"
          curl -sL "https://github.com/gruntwork-io/terragrunt/releases/download/${LATEST_VERSION}/terragrunt_linux_amd64" -o /usr/local/bin/terragrunt
          
          chmod +x /usr/local/bin/terragrunt
          
          terragrunt -v

      - name: Set TF variable environment
        run: |
          echo "TF_VAR_repository_name=\"${{ github.event.inputs.repo-name }}\"" >> $GITHUB_ENV
          echo "TF_VAR_repository_description=\"${{ github.event.inputs.repo-description }}\"" >> $GITHUB_ENV
          echo "TF_VAR_repository_auto_init=${{ github.event.inputs.auto-init }}" >> $GITHUB_ENV
          echo "TF_VAR_additional_branches='${{ github.event.inputs.additional-branches }}'" >> $GITHUB_ENV
          echo "TF_VAR_github_owner=${{ github.event.inputs.github-owner }}" >> $GITHUB_ENV
          echo "TF_VAR_github_token=${{ secrets.GH_PAT }}" >> $GITHUB_ENV
          echo "TF_VAR_visibility=${{ github.event.inputs.visibility }}" >> $GITHUB_ENV

      - name: Configure backend credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.B2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.B2_SECRET_ACCESS_KEY }}
          AWS_REQUEST_CHECKSUM_CALCULATION: ${{ secrets.AWS_REQUEST_CHECKSUM_CALCULATION }}
          AWS_RESPONSE_CHECKSUM_VALIDATION: ${{ secrets.AWS_RESPONSE_CHECKSUM_VALIDATION }}
        run: |
          echo "Terraform backend credentials configured."

      - name: Terragrunt Plan (Apply or Destroy)
        working-directory: ./environments/github/repos/BasicRepository
        run: |
          if [ "${{ github.event.inputs.destroy }}" == "true" ]; then
            echo "Running destroy plan..."
            terragrunt plan -destroy
          else
            echo "Running standard plan..."
            terragrunt plan
          fi

  apply:
    runs-on: ubuntu-latest
    needs: plan
    environment:
      name: github_repo_deployment
      url: ${{ github.server_url }}/repos/${{ github.repository }}/environments/github_repo_deployment

    steps:
      - uses: actions/checkout@v5

      - name: Set up OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: latest
          tofu_wrapper: false

      - name: Install latest Terragrunt
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/gruntwork-io/terragrunt/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/gruntwork-io/terragrunt/releases/download/${LATEST_VERSION}/terragrunt_linux_amd64" -o /usr/local/bin/terragrunt
          chmod +x /usr/local/bin/terragrunt

      - name: Set TF variable environment
        run: |
          echo "TF_VAR_repository_name=\"${{ github.event.inputs.repo-name }}\"" >> $GITHUB_ENV
          echo "TF_VAR_repository_description=\"${{ github.event.inputs.repo-description }}\"" >> $GITHUB_ENV
          echo "TF_VAR_repository_auto_init=${{ github.event.inputs.auto-init }}" >> $GITHUB_ENV
          echo "TF_VAR_additional_branches='${{ github.event.inputs.additional-branches }}'" >> $GITHUB_ENV
          echo "TF_VAR_github_owner=${{ github.event.inputs.github-owner }}" >> $GITHUB_ENV
          echo "TF_VAR_github_token=${{ secrets.GITHUB_PAT }}" >> $GITHUB_ENV
          echo "TF_VAR_visibility=${{ github.event.inputs.visibility }}" >> $GITHUB_ENV

      - name: Configure backend credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.B2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.B2_SECRET_ACCESS_KEY }}
          AWS_REQUEST_CHECKSUM_CALCULATION: ${{ secrets.AWS_REQUEST_CHECKSUM_CALCULATION }}
          AWS_RESPONSE_CHECKSUM_VALIDATION: ${{ secrets.AWS_RESPONSE_CHECKSUM_VALIDATION }}
        run: |
          echo "Terraform backend credentials configured."

      - name: Apply or Destroy Terragrunt
        working-directory: ./environments/github/repos/BasicRepository
        run: |
          if [ "${{ github.event.inputs.destroy }}" == "true" ]; then
            terragrunt destroy -auto-approve
          else
            terragrunt apply -auto-approve
          fi
